rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() { return request.auth != null; }
    function uid() { return request.auth.uid; }

    function isValidJoinCode(id) {
      return id.matches('^[A-Z0-9]{6}$');
    }

    function isString(x) { return x is string; }
    function isMap(x) { return x is map; }

    function sessionDoc(sessionId) {
      return get(/databases/$(database)/documents/sessions/$(sessionId));
    }

    function isSessionOwner(sessionId) {
      return isSignedIn()
        && sessionDoc(sessionId).exists()
        && sessionDoc(sessionId).data.ownerId == uid();
    }

    // ---- Block accidental legacy top-level path ----
    match /programs/{programId} {
      allow read, write: if false;
    }

    // ---- Public: join routing (read only) ----
    match /joinCodes/{joinCode} {
      allow read: if isValidJoinCode(joinCode);

      allow create: if isSignedIn()
        && isMap(request.resource.data)
        && request.resource.data.keys().hasOnly(['sessionId', 'ownerId', 'createdAt', 'active'])
        && request.resource.data.ownerId == uid()
        && isString(request.resource.data.sessionId)
        && request.resource.data.active is bool;

      allow update: if isSignedIn()
        && resource.data.ownerId == uid();

      allow delete: if false;
    }

    // ---- Owners ----
    match /owners/{ownerId} {
      allow read, write: if isSignedIn() && uid() == ownerId;

      // ---- Steg 7: Programs under owner ----
      match /programs/{programId} {
        allow get, list: if isSignedIn() && uid() == ownerId;

        allow create: if isSignedIn()
          && uid() == ownerId
          && isMap(request.resource.data)
          && request.resource.data.keys().hasOnly(['programId','ownerId','title','items','createdAt','updatedAt'])
          && request.resource.data.ownerId == uid()
          && isString(request.resource.data.title)
          && request.resource.data.title.size() > 0
          && request.resource.data.title.size() <= 120
          && request.resource.data.items is list;

        allow update: if isSignedIn()
          && uid() == ownerId
          && resource.data.ownerId == uid();

        allow delete: if false;
      }
    }

    // ---- Sessions ----
    match /sessions/{sessionId} {

      // Session metadata: owner-only
      allow get: if isSignedIn() && resource.data.ownerId == uid();
      allow create: if isSignedIn() && request.resource.data.ownerId == uid();
      allow update: if isSignedIn() && resource.data.ownerId == uid();
      allow list, delete: if false;

      // ---- Live state ----
      match /state/{docId} {
        allow read: if docId == "live";
        allow write: if docId == "live" && isSessionOwner(sessionId);
      }

      // ---- Rounds ----
      match /rounds/{roundId} {
        allow get, list: if isSessionOwner(sessionId);

        match /agg/{docId} {
          allow read: if docId == "live";
          allow write: if false; // kun server (Admin SDK)
        }

        match /votes/{clientId} {
          allow get: if true;
          allow list: if false;

          allow create: if
            !exists(/databases/$(database)/documents/sessions/$(sessionId)/rounds/$(roundId)/votes/$(clientId))
            && isMap(request.resource.data)
            && request.resource.data.keys().hasOnly(['clientId', 'createdAt', 'mode', 'value'])
            && request.resource.data.clientId == clientId
            && isString(request.resource.data.mode);

          allow update, delete: if false;
        }
      }
    }
  }
}
