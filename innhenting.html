<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <title>Innhenting</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="app.css" />
</head>

<body>
  <h1>Innhenting</h1>

  <div id="infoBox" class="mt20"></div>
  <div id="stateBox" class="mt20"></div>
  <div id="voteBox" class="mt20"></div>
  <div id="msgBox" class="mt20"></div>

  <div class="mt20">
    <button id="backBtn">Tilbake</button>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="config.js"></script>
  <script src="app.js"></script>

  <script>
    const infoBox = document.getElementById("infoBox");
    const stateBox = document.getElementById("stateBox");
    const voteBox = document.getElementById("voteBox");
    const msgBox = document.getElementById("msgBox");
    const backBtn = document.getElementById("backBtn");

    let unsubState = null;
    let unsubLock = null;

    let currentSessionId = null;
    let currentJoinCode = null;

    let currentRoundId = null;

    // lockState: "none" (ingen roundId) | "unknown" (sjekker) | "unlocked" | "locked"
    let lockState = "none";

    function setMsg(html) {
      msgBox.innerHTML = html || "";
    }

    function renderInfo() {
      infoBox.innerHTML = `
        <strong>Tilkobling</strong><br>
        sessionId: <span class="mono">${currentSessionId || "(mangler)"}</span><br>
        joinCode: <span class="mono">${currentJoinCode || "(mangler)"}</span><br>
        clientId: <span class="mono">${App.getClientId()}</span>
      `;
    }

    function safeJson(v) {
      try { return JSON.stringify(v, null, 2); } catch { return String(v); }
    }

    function renderState(state) {
      if (!state) {
        stateBox.innerHTML = `<strong>State</strong><br>Ingen state/live funnet (mangler doc eller ingen tilgang).`;
        return;
      }

      stateBox.innerHTML = `
        <strong>State (live)</strong><br>
        status: <span class="mono">${state.status ?? "-"}</span><br>
        mode: <span class="mono">${state.mode ?? "-"}</span><br>
        roundId: <span class="mono">${state.roundId ?? "-"}</span><br>
        question: <pre class="pre">${safeJson(state.question)}</pre>
      `;
    }

    function setVoteUIWaiting() {
      voteBox.innerHTML = `<strong>Stemme</strong><br>Venter på aktiv roundId (reset) og mode/spørsmål.`;
    }

    function setVoteUICheckingLock() {
      voteBox.innerHTML = `<strong>Stemme</strong><br><span class="mono">Sjekker om du allerede har stemt…</span>`;
    }

    function setVoteUILockedAlready() {
      voteBox.innerHTML = `<strong>Stemme</strong><br><span class="mono">Du har allerede stemt i denne runden (låst).</span>`;
    }

    function renderVoteButtonsYESNO() {
      voteBox.innerHTML = `
        <strong>Stemme (YES/NO)</strong>
        <div class="btnRow mt20">
          <button class="btn" id="btnYes">Ja</button>
          <button class="btn" id="btnNo">Nei</button>
        </div>
      `;
      document.getElementById("btnYes").addEventListener("click", () => submitVote(true));
      document.getElementById("btnNo").addEventListener("click", () => submitVote(false));
    }

    function renderVoteButtonsMULTI(choices) {
      const buttons = choices.map((c, idx) => {
        const label = (c && (c.label || c.text)) ? (c.label || c.text) : ("Valg " + (idx + 1));
        const value = (c && c.id) ? c.id : label;
        return `<button class="btn" data-v="${encodeURIComponent(String(value))}">${label}</button>`;
      }).join("");

      voteBox.innerHTML = `
        <strong>Stemme (MULTI)</strong>
        <div class="btnRow mt20" id="choiceRow">${buttons}</div>
      `;

      document.getElementById("choiceRow").addEventListener("click", (ev) => {
        const btn = ev.target.closest("button[data-v]");
        if (!btn) return;
        const v = decodeURIComponent(btn.getAttribute("data-v"));
        submitVote(v);
      });
    }

    function renderVoteUIForState(state) {
      // Ingen runde -> venter
      if (!state || !state.roundId) {
        lockState = "none";
        setVoteUIWaiting();
        return;
      }

      // Før vi vet om brukeren har stemt -> ikke vis knapper
      if (lockState === "unknown") {
        setVoteUICheckingLock();
        return;
      }

      // Hvis låst -> vis "already" (ikke "takk")
      if (lockState === "locked") {
        setVoteUILockedAlready();
        return;
      }

      // Hvis ulåst -> vis knapper iht mode
      const mode = state.mode;

      if (mode === "yesno") {
        renderVoteButtonsYESNO();
        return;
      }

      const q = state.question || null;
      const choices = q && Array.isArray(q.choices) ? q.choices : null;

      if (mode === "multi" && choices && choices.length >= 2) {
        renderVoteButtonsMULTI(choices);
        return;
      }

      // Fallback
      setVoteUIWaiting();
    }

    async function submitVote(value) {
      if (!currentSessionId) return;

      if (!currentRoundId) {
        setMsg("Kan ikke stemme: mangler roundId.");
        return;
      }

      // Skulle ikke være mulig å trykke her når lockState != unlocked,
      // men vi sikrer oss likevel.
      if (lockState !== "unlocked") {
        setMsg("");
        setVoteUILockedAlready();
        return;
      }

      setMsg("");
      try {
        const res = await App.submitVoteOnce(currentSessionId, currentRoundId, value);

        // Etter submit: uansett utfall er det låst etterpå (doc finnes)
        lockState = "locked";
        renderVoteUIForState({ roundId: currentRoundId, mode: "yesno", question: null });

        if (res && res.already) {
          // Viktig: ved refresh + nytt forsøk: ikke "takk"
          setMsg("");
        } else {
          // Kun ved reell ny stemme
          setMsg('<span class="mono">Takk! Stemmen er sendt.</span>');
        }
      } catch (e) {
        const msg = e && e.message ? e.message : String(e);
        setMsg('<strong>Kunne ikke sende stemme:</strong><br><span class="mono">' + msg + "</span>");
      }
    }

    function attachLock(sessionId, roundId) {
      if (unsubLock) unsubLock();

      // Ny runde -> vi vet ikke lock-status ennå
      lockState = "unknown";
      setMsg(""); // rydd meldinger ved runde-bytt
      // Vote UI vil vise "Sjekker..." til vi får første snapshot

      const clientId = App.getClientId();
      unsubLock = App.listenVoteLock(
        sessionId,
        roundId,
        clientId,
        (res) => {
          lockState = (res && res.exists) ? "locked" : "unlocked";
        },
        (err) => {
          const msg = err && err.message ? err.message : String(err);
          setMsg('<strong>Kunne ikke lese vote-lock:</strong><br><span class="mono">' + msg + "</span>");
          // Hvis vi ikke kan lese lock, velger vi å ikke åpne knapper (sikkert)
          lockState = "unknown";
        }
      );
    }

    function attachState(sessionId) {
      if (unsubState) unsubState();

      unsubState = App.listenLiveState(
        sessionId,
        (state) => {
          renderState(state);

          const newRoundId = state && state.roundId ? state.roundId : null;

          if (newRoundId !== currentRoundId) {
            currentRoundId = newRoundId;

            if (currentRoundId) {
              attachLock(currentSessionId, currentRoundId);
            } else {
              if (unsubLock) unsubLock();
              unsubLock = null;
              lockState = "none";
              setMsg("");
            }
          }

          // Render basert på state + lockState
          renderVoteUIForState(state);
        },
        (err) => {
          const msg = err && err.message ? err.message : String(err);
          setMsg('<strong>Kunne ikke lese state/live:</strong><br><span class="mono">' + msg + "</span>");
        }
      );
    }

    backBtn.addEventListener("click", () => {
      window.location.href = "join.html";
    });

    // Init – kun localStorage reads. Ingen writes.
    const p = App.getParticipantSession();
    if (!p || !p.sessionId || !p.joinCode) {
      setMsg('Mangler join-informasjon. Gå til <span class="mono">join.html</span> og skriv inn kode.');
      setVoteUIWaiting();
    } else {
      currentSessionId = p.sessionId;
      currentJoinCode = p.joinCode;
      renderInfo();
      attachState(currentSessionId);
    }
  </script>
</body>
</html>