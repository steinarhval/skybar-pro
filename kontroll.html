<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <title>Kontroll</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="app.css" />
</head>

<body>
  <h1>Kontrollpanel</h1>

  <button id="loginBtn">Logg inn med Google</button>
  <button id="startSessionBtn">Start ny session</button>

  <div id="controlsBox" class="mt20"></div>

  <div id="sessionBox" class="mt20"></div>
  <div id="leaseBox" class="mt20"></div>
  <div id="statusBox" class="mt20"></div>
  <div id="errorBox" class="mt20"></div>
  <div id="userBox" class="mt20"></div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

  <script src="config.js"></script>
  <script src="app.js"></script>

  <script>
    const loginBtn = document.getElementById("loginBtn");
    const userBox = document.getElementById("userBox");
    const startSessionBtn = document.getElementById("startSessionBtn");
    const sessionBox = document.getElementById("sessionBox");
    const leaseBox = document.getElementById("leaseBox");
    const statusBox = document.getElementById("statusBox");
    const errorBox = document.getElementById("errorBox");
    const controlsBox = document.getElementById("controlsBox");

    let activeSessionId = null;
    let activeJoinCode = null;

    let unsubscribe = null;
    let leaseTicker = null;
    let lastState = null;

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;");
    }

    function setError(msg) {
      if (!msg) { errorBox.innerHTML = ""; return; }
      errorBox.innerHTML = `<strong>Feil:</strong><br><span class="mono">${escapeHtml(msg)}</span>`;
    }

    let statusTimer = null;
    function setStatus(msg, kind) {
      if (statusTimer) clearTimeout(statusTimer);
      if (!msg) { statusBox.innerHTML = ""; return; }

      const label = kind === "err" ? "Status (feil)"
                  : kind === "warn" ? "Status (obs)"
                  : kind === "ok" ? "Status"
                  : "Status";

      const now = new Date();
      const hh = String(now.getHours()).padStart(2, "0");
      const mm = String(now.getMinutes()).padStart(2, "0");
      const ss = String(now.getSeconds()).padStart(2, "0");

      statusBox.innerHTML = `
        <strong>${label}:</strong>
        <span class="mono">${hh}:${mm}:${ss}</span><br>
        ${escapeHtml(msg)}
      `;

      statusTimer = setTimeout(() => {
        statusBox.innerHTML = "";
      }, 3500);
    }

    function renderUser(user) {
      if (!user) { userBox.innerHTML = ""; return; }
      userBox.innerHTML = `
        <strong>Innlogget som:</strong><br>
        ${escapeHtml(user.displayName || "")}<br>
        ${escapeHtml(user.email || "")}<br>
        ownerId (user.uid): <span class="mono">${escapeHtml(user.uid)}</span><br>
        clientId (localStorage): <span class="mono">${escapeHtml(App.getClientId())}</span>
      `;
    }

    function toMillisMaybe(ts) {
      if (!ts) return null;
      if (typeof ts.toMillis === "function") return ts.toMillis();
      if (typeof ts.seconds === "number") return (ts.seconds * 1000) + Math.floor((ts.nanoseconds || 0) / 1e6);
      return null;
    }

    function formatLease(state) {
      if (!state) {
        return `<strong>Controller lease</strong><br>Ingen state/live lest ennå (mangler doc eller tilgang).`;
      }

      const cid = state.controllerId || "(ikke satt)";
      const untilMs = toMillisMaybe(state.controllerLeaseUntil);

      const nowMs = Date.now();
      const active = (untilMs !== null) ? (untilMs > nowMs) : false;
      const remaining = (untilMs !== null) ? Math.max(0, Math.round((untilMs - nowMs) / 1000)) : null;

      const mine = (cid === App.getClientId());

      return `
        <strong>Controller lease</strong><br>
        controllerId: <span class="mono">${escapeHtml(cid)}</span><br>
        status: ${active ? "aktiv" : "utløpt/ikke satt"}<br>
        gjenstår: ${remaining === null ? "-" : (remaining + " sek")}<br>
        min controller: ${mine ? "ja" : "nei"}
      `;
    }

    function renderLease(state) {
      leaseBox.innerHTML = formatLease(state);
    }

    function parseChoices(text) {
      const lines = String(text || "")
        .split("\n")
        .map(x => x.trim())
        .filter(Boolean);

      const choices = [];
      const seen = new Set();

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        const parts = line.split("|").map(x => x.trim()).filter(Boolean);

        let id = "";
        let label = "";

        if (parts.length >= 2) {
          id = parts[0];
          label = parts.slice(1).join(" | ");
        } else {
          label = line;
          id = line;
        }

        if (!id || !label) throw new Error("Ugyldig choice på linje " + (i + 1) + ".");
        if (seen.has(id)) throw new Error("Duplisert choice-id: " + id);
        seen.add(id);

        choices.push({ id, label });
      }

      if (choices.length < 2) throw new Error("Multi krever minst 2 choices.");
      return choices;
    }

    function buildUrl(path, params) {
      const u = new URL(path, window.location.href);
      Object.entries(params || {}).forEach(([k, v]) => {
        if (v == null || v === "") return;
        u.searchParams.set(k, String(v));
      });
      return u.toString();
    }

    function openInNewTab(url) {
      // noopener for sikkerhet – og for å slippe at popup får kontroll på window.opener
      window.open(url, "_blank", "noopener");
    }

    function renderSessionBox() {
      if (!activeSessionId) {
        sessionBox.innerHTML = "";
        return;
      }

      const displayUrl = (activeJoinCode)
        ? buildUrl("display.html", { joinCode: activeJoinCode })
        : null;

      const collectUrl = (activeJoinCode)
        ? buildUrl("innhenting.html", { joinCode: activeJoinCode })
        : null;

      const canOpen = !!activeJoinCode;

      sessionBox.innerHTML = `
        <strong>Aktiv session</strong><br>
        sessionId: <span class="mono">${escapeHtml(activeSessionId || "-")}</span><br>
        joinCode: <span class="mono">${escapeHtml(activeJoinCode || "-")}</span><br><br>

        <div class="btnRow">
          <button class="btn" id="openDisplayBtn" ${canOpen ? "" : "disabled"}>Åpne Display (joinCode)</button>
          <button class="btn" id="openCollectBtn" ${canOpen ? "" : "disabled"}>Åpne Innhenting (joinCode)</button>
        </div>

        <div class="mt20">
          Display-link: <span class="mono">${escapeHtml(displayUrl || "-")}</span><br>
          Innhenting-link: <span class="mono">${escapeHtml(collectUrl || "-")}</span>
        </div>
      `;

      const openDisplayBtn = document.getElementById("openDisplayBtn");
      const openCollectBtn = document.getElementById("openCollectBtn");

      if (openDisplayBtn) {
        openDisplayBtn.addEventListener("click", () => {
          if (!activeJoinCode) return;
          openInNewTab(buildUrl("display.html", { joinCode: activeJoinCode }));
          setStatus("Åpnet display i nytt vindu.", "ok");
        });
      }

      if (openCollectBtn) {
        openCollectBtn.addEventListener("click", () => {
          if (!activeJoinCode) return;
          // innhenting.html støtter nå joinCode direkte (se oppdatert fil under)
          openInNewTab(buildUrl("innhenting.html", { joinCode: activeJoinCode }));
          setStatus("Åpnet innhenting i nytt vindu.", "ok");
        });
      }
    }

    function renderControls() {
      if (!activeSessionId) {
        controlsBox.innerHTML = `<strong>Controller UI</strong><br>Start/velg en aktiv session først.`;
        return;
      }

      const status = lastState && lastState.status ? lastState.status : "(ukjent)";
      const roundId = lastState && lastState.roundId ? lastState.roundId : "-";
      const mode = lastState && lastState.mode ? lastState.mode : "";

      const q = lastState && lastState.question ? lastState.question : null;
      const qText = q && q.text ? String(q.text) : "";

      const multiChoices = (mode === "multi" && q && Array.isArray(q.choices))
        ? q.choices.map(c => `${c.id} | ${c.label}`).join("\n")
        : "yes | ja\nno | nei";

      controlsBox.innerHTML = `
        <strong>Controller UI (Steg 6)</strong><br>
        status: <span class="mono">${escapeHtml(status)}</span> |
        mode: <span class="mono">${escapeHtml(mode || "-")}</span> |
        roundId: <span class="mono">${escapeHtml(roundId)}</span><br><br>

        <strong>Spørsmål</strong><br>
        <label>
          Mode:
          <select id="modeSel" class="inputWide">
            <option value="multi" ${mode === "multi" ? "selected" : ""}>multi</option>
            <option value="likert" ${mode === "likert" ? "selected" : ""}>likert</option>
            <option value="open" ${mode === "open" ? "selected" : ""}>open</option>
            <option value="wordcloud" ${mode === "wordcloud" ? "selected" : ""}>wordcloud</option>
          </select>
        </label>

        <div class="mt20">
          <label>Spørsmålstekst (valgfri, men anbefalt):</label><br>
          <textarea id="qText" class="inputArea" rows="2" placeholder="Skriv spørsmålet her...">${escapeHtml(qText)}</textarea>
        </div>

        <div class="mt20" id="multiBox">
          <label>Multi choices (én per linje): <span class="mono">id | label</span></label><br>
          <textarea id="multiChoices" class="inputArea" rows="5">${escapeHtml(multiChoices)}</textarea>
        </div>

        <div class="mt20 btnRow">
          <button class="btn" id="setQuestionBtn">Set question (mode + question)</button>
          <button class="btn" id="startQuestionBtn">Start (set + reset + collect)</button>
        </div>

        <div class="mt20 btnRow">
          <button class="btn" id="collectBtn">Collect</button>
          <button class="btn" id="resultsBtn">Results</button>
          <button class="btn" id="resetBtn">Reset (ny roundId)</button>
          <button class="btn" id="endSessionBtn">End session</button>
        </div>

        <div class="mt20">
          Tips: Normal flyt er <span class="mono">Set question</span> → <span class="mono">Start</span> → (Collect/Results) → <span class="mono">Reset</span> for neste runde.
        </div>
      `;

      const modeSel = document.getElementById("modeSel");

      document.getElementById("setQuestionBtn").addEventListener("click", async () => {
        try {
          setError("");
          setStatus("", "info");

          const m = modeSel.value;
          const text = (document.getElementById("qText").value || "").trim();

          let question = {};
          if (text) question.text = text;

          if (m === "multi") {
            const rawChoices = document.getElementById("multiChoices").value;
            question.choices = parseChoices(rawChoices);
          }

          await App.setQuestionLease(activeSessionId, m, question);
          setStatus("Spørsmål oppdatert (mode + question).", "ok");
        } catch (err) {
          const msg = (err && err.message) ? err.message : String(err);
          setError(msg);
          setStatus("Set question feilet.", "err");
          console.error(err);
        }
      });

      document.getElementById("startQuestionBtn").addEventListener("click", async () => {
        try {
          setError("");
          setStatus("", "info");

          const m = modeSel.value;
          const text = (document.getElementById("qText").value || "").trim();

          let question = {};
          if (text) question.text = text;

          if (m === "multi") {
            const rawChoices = document.getElementById("multiChoices").value;
            question.choices = parseChoices(rawChoices);
          }

          const res = await App.startQuestionLease(activeSessionId, m, question);
          setStatus("Startet ny runde: " + res.roundId, "ok");
        } catch (err) {
          const msg = (err && err.message) ? err.message : String(err);
          setError(msg);
          setStatus("Start feilet.", "err");
          console.error(err);
        }
      });

      document.getElementById("collectBtn").addEventListener("click", async () => {
        try {
          setError("");
          setStatus("", "info");
          await App.setLiveStatusLease(activeSessionId, "collect");
          setStatus("Status satt til collect.", "ok");
        } catch (err) {
          const msg = (err && err.message) ? err.message : String(err);
          setError(msg);
          setStatus("Collect feilet.", "err");
          console.error(err);
        }
      });

      document.getElementById("resultsBtn").addEventListener("click", async () => {
        try {
          setError("");
          setStatus("", "info");
          await App.setLiveStatusLease(activeSessionId, "results");
          setStatus("Status satt til results.", "ok");
        } catch (err) {
          const msg = (err && err.message) ? err.message : String(err);
          setError(msg);
          setStatus("Results feilet.", "err");
          console.error(err);
        }
      });

      document.getElementById("resetBtn").addEventListener("click", async () => {
        try {
          setError("");
          setStatus("", "info");
          const res = await App.resetRoundLease(activeSessionId);
          setStatus("Ny roundId: " + res.roundId, "ok");
        } catch (err) {
          const msg = (err && err.message) ? err.message : String(err);
          setError(msg);
          setStatus("Reset feilet.", "err");
          console.error(err);
        }
      });

      document.getElementById("endSessionBtn").addEventListener("click", async () => {
        try {
          setError("");
          setStatus("", "info");

          await App.endSession(activeSessionId);

          activeSessionId = null;
          activeJoinCode = null;
          lastState = null;
          if (unsubscribe) unsubscribe();
          unsubscribe = null;

          sessionBox.innerHTML = `<strong>Session avsluttet.</strong>`;
          controlsBox.innerHTML = "";
          renderLease(null);

          setStatus("Session avsluttet.", "ok");
        } catch (err) {
          const msg = (err && err.message) ? err.message : String(err);
          setError(msg);
          setStatus("End session feilet.", "err");
          console.error(err);
        }
      });
    }

    function startLeaseTicker() {
      if (leaseTicker) clearInterval(leaseTicker);
      leaseTicker = setInterval(() => {
        renderLease(lastState);
      }, 1000);
    }

    function attachStateListener(sessionId) {
      if (unsubscribe) unsubscribe();

      unsubscribe = App.listenLiveState(
        sessionId,
        (data) => {
          lastState = data;
          renderLease(data);
          renderControls();
        },
        (err) => {
          setError("Kunne ikke lese state/live: " + (err && err.message ? err.message : String(err)));
          setStatus("Kunne ikke lese state/live.", "err");
        }
      );

      startLeaseTicker();
    }

    loginBtn.addEventListener("click", async () => {
      try {
        setError("");
        setStatus("", "info");
        const user = await App.ensureSignedInWithGoogle();
        renderUser(user);
        setStatus("Innlogging ok.", "ok");
      } catch (err) {
        setError(err && err.message ? err.message : String(err));
        setStatus("Innlogging feilet.", "err");
        console.error(err);
      }
    });

    startSessionBtn.addEventListener("click", async () => {
      try {
        setError("");
        setStatus("", "info");
        const res = await App.startOrReplaceSession({ saveResults: true, programId: null });

        activeSessionId = res.sessionId;
        activeJoinCode = res.joinCode;

        renderSessionBox();
        attachStateListener(res.sessionId);
        setStatus("Ny session startet.", "ok");
      } catch (err) {
        const msg = (err && err.message) ? err.message : String(err);
        setError(msg);
        setStatus("Kunne ikke starte ny session.", "err");
        console.error(err);
      }
    });

    App.auth.onAuthStateChanged(async (user) => {
      renderUser(user);

      if (!user) {
        activeSessionId = null;
        activeJoinCode = null;
        lastState = null;
        if (unsubscribe) unsubscribe();
        unsubscribe = null;
        if (leaseTicker) clearInterval(leaseTicker);
        leaseTicker = null;
        leaseBox.innerHTML = "";
        sessionBox.innerHTML = "";
        controlsBox.innerHTML = "";
        statusBox.innerHTML = "";
        setError("");
        return;
      }

      try {
        setError("");
        const info = await App.getActiveSessionInfo(user.uid);
        if (info && info.activeSessionId) {
          activeSessionId = info.activeSessionId;
          activeJoinCode = info.activeJoinCode;

          renderSessionBox();
          attachStateListener(info.activeSessionId);
          setStatus("Aktiv session lastet (ingen writes).", "ok");
        } else {
          activeSessionId = null;
          activeJoinCode = null;
          renderSessionBox();
          leaseBox.innerHTML = `<strong>Controller lease</strong><br>Ingen aktiv session funnet på owner-peker.`;
          renderControls();
          setStatus("Ingen aktiv session funnet.", "warn");
        }
      } catch (e) {
        setError(e && e.message ? e.message : String(e));
        setStatus("Kunne ikke lese owner-peker.", "err");
        console.error(e);
      }
    });
  </script>
</body>
</html>
