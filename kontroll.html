<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <title>Kontroll</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="app.css" />
</head>

<body>
  <h1>Kontrollpanel</h1>

  <button id="loginBtn">Logg inn med Google</button>
  <button id="startSessionBtn">Start ny session</button>

  <div id="controlsBox" class="mt20"></div>

  <div id="sessionBox" class="mt20"></div>
  <div id="leaseBox" class="mt20"></div>
  <div id="errorBox" class="mt20"></div>
  <div id="userBox" class="mt20"></div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

  <script src="config.js"></script>
  <script src="app.js"></script>

  <script>
    const loginBtn = document.getElementById("loginBtn");
    const userBox = document.getElementById("userBox");
    const startSessionBtn = document.getElementById("startSessionBtn");
    const sessionBox = document.getElementById("sessionBox");
    const leaseBox = document.getElementById("leaseBox");
    const errorBox = document.getElementById("errorBox");
    const controlsBox = document.getElementById("controlsBox");

    let activeSessionId = null;
    let unsubscribe = null;
    let leaseTicker = null;
    let lastState = null;

    function setError(msg) {
      if (!msg) { errorBox.innerHTML = ""; return; }
      errorBox.innerHTML = `<strong>Feil:</strong><br><span class="mono">${msg}</span>`;
    }

    function renderUser(user) {
      if (!user) { userBox.innerHTML = ""; return; }
      userBox.innerHTML = `
        <strong>Innlogget som:</strong><br>
        ${user.displayName || ""}<br>
        ${user.email || ""}<br>
        ownerId (user.uid): <span class="mono">${user.uid}</span><br>
        clientId (localStorage): <span class="mono">${App.getClientId()}</span>
      `;
    }

    function toMillisMaybe(ts) {
      if (!ts) return null;
      if (typeof ts.toMillis === "function") return ts.toMillis();
      if (typeof ts.seconds === "number") return (ts.seconds * 1000) + Math.floor((ts.nanoseconds || 0) / 1e6);
      return null;
    }

    function formatLease(state) {
      if (!state) {
        return `<strong>Controller lease</strong><br>Ingen state/live lest ennå (mangler doc eller tilgang).`;
      }

      const cid = state.controllerId || "(ikke satt)";
      const untilMs = toMillisMaybe(state.controllerLeaseUntil);

      const nowMs = Date.now();
      const active = (untilMs !== null) ? (untilMs > nowMs) : false;
      const remaining = (untilMs !== null) ? Math.max(0, Math.round((untilMs - nowMs) / 1000)) : null;

      const mine = (cid === App.getClientId());

      return `
        <strong>Controller lease</strong><br>
        controllerId: <span class="mono">${cid}</span><br>
        status: ${active ? "aktiv" : "utløpt/ikke satt"}<br>
        gjenstår: ${remaining === null ? "-" : (remaining + " sek")}<br>
        min controller: ${mine ? "ja" : "nei"}
      `;
    }

    function renderLease(state) {
      leaseBox.innerHTML = formatLease(state);
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;");
    }

    function parseChoices(text) {
      // Format per linje: id | label
      // Tillater også "label" alene => id settes til label (trim)
      const lines = String(text || "")
        .split("\n")
        .map(x => x.trim())
        .filter(Boolean);

      const choices = [];
      const seen = new Set();

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        const parts = line.split("|").map(x => x.trim()).filter(Boolean);

        let id = "";
        let label = "";

        if (parts.length >= 2) {
          id = parts[0];
          label = parts.slice(1).join(" | "); // hvis label inneholder |
        } else {
          label = line;
          id = line;
        }

        if (!id || !label) throw new Error("Ugyldig choice på linje " + (i + 1) + ".");
        if (seen.has(id)) throw new Error("Duplisert choice-id: " + id);
        seen.add(id);

        choices.push({ id, label });
      }

      if (choices.length < 2) throw new Error("Multi krever minst 2 choices.");
      return choices;
    }

    function renderControls() {
      if (!activeSessionId) {
        controlsBox.innerHTML = `<strong>Controller UI</strong><br>Start/velg en aktiv session først.`;
        return;
      }

      const status = lastState && lastState.status ? lastState.status : "(ukjent)";
      const roundId = lastState && lastState.roundId ? lastState.roundId : "-";
      const mode = lastState && lastState.mode ? lastState.mode : "";

      const q = lastState && lastState.question ? lastState.question : null;
      const qText = q && q.text ? String(q.text) : "";

      const multiChoices = (mode === "multi" && q && Array.isArray(q.choices))
        ? q.choices.map(c => `${c.id} | ${c.label}`).join("\n")
        : "yes | ja\nno | nei";

      controlsBox.innerHTML = `
        <strong>Controller UI (Steg 6)</strong><br>
        status: <span class="mono">${escapeHtml(status)}</span> |
        mode: <span class="mono">${escapeHtml(mode || "-")}</span> |
        roundId: <span class="mono">${escapeHtml(roundId)}</span><br><br>

        <strong>Spørsmål</strong><br>
        <label>
          Mode:
          <select id="modeSel" class="inputWide">
            <option value="multi" ${mode === "multi" ? "selected" : ""}>multi</option>
            <option value="likert" ${mode === "likert" ? "selected" : ""}>likert</option>
            <option value="open" ${mode === "open" ? "selected" : ""}>open</option>
            <option value="wordcloud" ${mode === "wordcloud" ? "selected" : ""}>wordcloud</option>
          </select>
        </label>

        <div class="mt20">
          <label>Spørsmålstekst (valgfri, men anbefalt):</label><br>
          <textarea id="qText" class="inputArea" rows="2" placeholder="Skriv spørsmålet her...">${escapeHtml(qText)}</textarea>
        </div>

        <div class="mt20" id="multiBox">
          <label>Multi choices (én per linje): <span class="mono">id | label</span></label><br>
          <textarea id="multiChoices" class="inputArea" rows="5">${escapeHtml(multiChoices)}</textarea>
        </div>

        <div class="mt20 btnRow">
          <button class="btn" id="setQuestionBtn">Set question (mode + question)</button>
          <button class="btn" id="startQuestionBtn">Start (set + reset + collect)</button>
        </div>

        <div class="mt20 btnRow">
          <button class="btn" id="collectBtn">Collect</button>
          <button class="btn" id="resultsBtn">Results</button>
          <button class="btn" id="resetBtn">Reset (ny roundId)</button>
          <button class="btn" id="endSessionBtn">End session</button>
        </div>

        <div class="mt20">
          Tips: Normal flyt er <span class="mono">Set question</span> → <span class="mono">Start</span> → (Collect/Results) → <span class="mono">Reset</span> for neste runde.
        </div>
      `;

      const modeSel = document.getElementById("modeSel");
      const multiBox = document.getElementById("multiBox");

      function updateModeUI() {
        const m = modeSel.value;
        multiBox.style.display = (m === "multi") ? "block" : "none"; // NB: inline style? Nei – dette er dynamisk. Grunnlov sier ingen dynamisk styling direkte i JS, kun class-toggling.
      }

      // Grunnlov: ingen dynamisk styling i JS -> vi gjør class-toggling i stedet:
      function setHidden(el, hidden) {
        if (!el) return;
        el.classList.toggle("hidden", !!hidden);
      }

      // legg på hidden-klassen i CSS? Den finnes ikke – vi legger minimal i app.css? Nei. Da bryter vi “bare en fil”-kravet ikke, men du har ikke bedt om å endre css nå.
      // Løsning uten css-endring: Vi dropper toggling og lar multiBox alltid stå, men brukeren ignorerer den for andre modes.
      // => Gjør det enkelt og robust: alltid vis multiBox, men med liten forklaring. (Så slipper vi stylingkrangel.)
      // Vi gjør derfor ikke updateModeUI().

      document.getElementById("setQuestionBtn").addEventListener("click", async () => {
        try {
          setError("");
          const m = modeSel.value;
          const text = (document.getElementById("qText").value || "").trim();

          let question = {};
          if (text) question.text = text;

          if (m === "multi") {
            const rawChoices = document.getElementById("multiChoices").value;
            question.choices = parseChoices(rawChoices);
          }

          await App.setQuestionLease(activeSessionId, m, question);
          alert("Spørsmål oppdatert (mode + question).");
        } catch (err) {
          const msg = (err && err.message) ? err.message : String(err);
          setError(msg);
          alert("Set question feilet: " + msg);
        }
      });

      document.getElementById("startQuestionBtn").addEventListener("click", async () => {
        try {
          setError("");
          const m = modeSel.value;
          const text = (document.getElementById("qText").value || "").trim();

          let question = {};
          if (text) question.text = text;

          if (m === "multi") {
            const rawChoices = document.getElementById("multiChoices").value;
            question.choices = parseChoices(rawChoices);
          }

          const res = await App.startQuestionLease(activeSessionId, m, question);
          alert("Startet ny runde: " + res.roundId);
        } catch (err) {
          const msg = (err && err.message) ? err.message : String(err);
          setError(msg);
          alert("Start feilet: " + msg);
        }
      });

      document.getElementById("collectBtn").addEventListener("click", async () => {
        try {
          setError("");
          await App.setLiveStatusLease(activeSessionId, "collect");
        } catch (err) {
          const msg = (err && err.message) ? err.message : String(err);
          setError(msg);
          alert("Collect feilet: " + msg);
        }
      });

      document.getElementById("resultsBtn").addEventListener("click", async () => {
        try {
          setError("");
          await App.setLiveStatusLease(activeSessionId, "results");
        } catch (err) {
          const msg = (err && err.message) ? err.message : String(err);
          setError(msg);
          alert("Results feilet: " + msg);
        }
      });

      document.getElementById("resetBtn").addEventListener("click", async () => {
        try {
          setError("");
          const res = await App.resetRoundLease(activeSessionId);
          alert("Ny roundId: " + res.roundId);
        } catch (err) {
          const msg = (err && err.message) ? err.message : String(err);
          setError(msg);
          alert("Reset feilet: " + msg);
        }
      });

      document.getElementById("endSessionBtn").addEventListener("click", async () => {
        try {
          setError("");
          if (!confirm("Vil du avslutte sessionen?")) return;

          await App.endSession(activeSessionId);

          activeSessionId = null;
          lastState = null;
          if (unsubscribe) unsubscribe();
          unsubscribe = null;

          sessionBox.innerHTML = `<strong>Session avsluttet.</strong>`;
          controlsBox.innerHTML = "";
          renderLease(null);
          alert("Session avsluttet.");
        } catch (err) {
          const msg = (err && err.message) ? err.message : String(err);
          setError(msg);
          alert("End session feilet: " + msg);
        }
      });
    }

    function startLeaseTicker() {
      if (leaseTicker) clearInterval(leaseTicker);
      leaseTicker = setInterval(() => {
        renderLease(lastState);
      }, 1000);
    }

    function attachStateListener(sessionId) {
      if (unsubscribe) unsubscribe();

      unsubscribe = App.listenLiveState(
        sessionId,
        (data) => {
          lastState = data;
          renderLease(data);
          renderControls();
        },
        (err) => {
          setError("Kunne ikke lese state/live: " + (err && err.message ? err.message : String(err)));
        }
      );

      startLeaseTicker();
    }

    loginBtn.addEventListener("click", async () => {
      try {
        setError("");
        const user = await App.ensureSignedInWithGoogle();
        renderUser(user);
      } catch (err) {
        setError(err && err.message ? err.message : String(err));
        alert("Innlogging feilet: " + (err && err.message ? err.message : "ukjent feil"));
      }
    });

    startSessionBtn.addEventListener("click", async () => {
      try {
        setError("");
        const res = await App.startOrReplaceSession({ saveResults: true, programId: null });

        activeSessionId = res.sessionId;

        sessionBox.innerHTML = `
          <strong>Session startet:</strong><br>
          sessionId: <span class="mono">${res.sessionId}</span><br>
          joinCode: <span class="mono">${res.joinCode}</span><br>
          ownerId: <span class="mono">${res.ownerId}</span><br>
          docPath: <span class="mono">sessions/${res.sessionId}</span>
        `;

        attachStateListener(res.sessionId);
      } catch (err) {
        const msg = (err && err.message) ? err.message : String(err);
        setError(msg);
        alert("Kunne ikke starte ny session: " + msg);
      }
    });

    App.auth.onAuthStateChanged(async (user) => {
      renderUser(user);

      if (!user) {
        activeSessionId = null;
        lastState = null;
        if (unsubscribe) unsubscribe();
        unsubscribe = null;
        if (leaseTicker) clearInterval(leaseTicker);
        leaseTicker = null;
        leaseBox.innerHTML = "";
        sessionBox.innerHTML = "";
        controlsBox.innerHTML = "";
        setError("");
        return;
      }

      // Ingen auto-writes ved refresh. Kun les og vis.
      try {
        setError("");
        const info = await App.getActiveSessionInfo(user.uid);
        if (info && info.activeSessionId) {
          activeSessionId = info.activeSessionId;
          sessionBox.innerHTML = `
            <strong>Aktiv session (lest):</strong><br>
            sessionId: <span class="mono">${info.activeSessionId}</span><br>
            joinCode: <span class="mono">${info.activeJoinCode}</span><br>
            docPath: <span class="mono">sessions/${info.activeSessionId}</span>
          `;
          attachStateListener(info.activeSessionId);
        } else {
          leaseBox.innerHTML = `<strong>Controller lease</strong><br>Ingen aktiv session funnet på owner-peker.`;
          renderControls();
        }
      } catch (e) {
        setError(e && e.message ? e.message : String(e));
      }
    });
  </script>
</body>
</html>