<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <title>Kontroll</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="app.css" />
</head>

<body>
  <h1>Kontrollpanel</h1>

  <button id="loginBtn">Logg inn med Google</button>
  <button id="startSessionBtn">Start ny session</button>

  <div id="programsBox" class="mt20"></div>

  <div id="controlsBox" class="mt20"></div>

  <div id="sessionBox" class="mt20"></div>
  <div id="leaseBox" class="mt20"></div>
  <div id="statusBox" class="mt20"></div>
  <div id="errorBox" class="mt20"></div>
  <div id="userBox" class="mt20"></div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

  <script src="config.js"></script>
  <script src="app.js"></script>

  <script>
    const loginBtn = document.getElementById("loginBtn");
    const userBox = document.getElementById("userBox");
    const startSessionBtn = document.getElementById("startSessionBtn");
    const sessionBox = document.getElementById("sessionBox");
    const leaseBox = document.getElementById("leaseBox");
    const statusBox = document.getElementById("statusBox");
    const errorBox = document.getElementById("errorBox");
    const controlsBox = document.getElementById("controlsBox");
    const programsBox = document.getElementById("programsBox");

    let activeSessionId = null;
    let activeJoinCode = null;

    let unsubscribe = null;
    let leaseTicker = null;
    let lastState = null;

    // Steg 7 UI-state (kun lokalt, ingen auto-writes)
    let currentUser = null;
    let programDraftItems = [];       // [{mode, question}]
    let programsCache = [];           // list for owner
    let loadedProgram = null;         // {programId,title,items}
    let loadedProgramIndex = 0;

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;");
    }

    function setError(msg) {
      if (!msg) { errorBox.innerHTML = ""; return; }
      errorBox.innerHTML = `<strong>Feil:</strong><br><span class="mono">${escapeHtml(msg)}</span>`;
    }

    let statusTimer = null;
    function setStatus(msg, kind) {
      if (statusTimer) clearTimeout(statusTimer);
      if (!msg) { statusBox.innerHTML = ""; return; }

      const label = kind === "err" ? "Status (feil)"
                  : kind === "warn" ? "Status (obs)"
                  : kind === "ok" ? "Status"
                  : "Status";

      const now = new Date();
      const hh = String(now.getHours()).padStart(2, "0");
      const mm = String(now.getMinutes()).padStart(2, "0");
      const ss = String(now.getSeconds()).padStart(2, "0");

      statusBox.innerHTML = `
        <strong>${label}:</strong>
        <span class="mono">${hh}:${mm}:${ss}</span><br>
        ${escapeHtml(msg)}
      `;

      statusTimer = setTimeout(() => {
        statusBox.innerHTML = "";
      }, 3500);
    }

    function renderUser(user) {
      if (!user) { userBox.innerHTML = ""; return; }
      userBox.innerHTML = `
        <strong>Innlogget som:</strong><br>
        ${escapeHtml(user.displayName || "")}<br>
        ${escapeHtml(user.email || "")}<br>
        ownerId (user.uid): <span class="mono">${escapeHtml(user.uid)}</span><br>
        clientId (localStorage): <span class="mono">${escapeHtml(App.getClientId())}</span>
      `;
    }

    function toMillisMaybe(ts) {
      if (!ts) return null;
      if (typeof ts.toMillis === "function") return ts.toMillis();
      if (typeof ts.seconds === "number") return (ts.seconds * 1000) + Math.floor((ts.nanoseconds || 0) / 1e6);
      return null;
    }

    function formatLease(state) {
      if (!state) {
        return `<strong>Controller lease</strong><br>Ingen state/live lest ennå (mangler doc eller tilgang).`;
      }

      const cid = state.controllerId || "(ikke satt)";
      const untilMs = toMillisMaybe(state.controllerLeaseUntil);

      const nowMs = Date.now();
      const active = (untilMs !== null) ? (untilMs > nowMs) : false;
      const remaining = (untilMs !== null) ? Math.max(0, Math.round((untilMs - nowMs) / 1000)) : null;

      const mine = (cid === App.getClientId());

      return `
        <strong>Controller lease</strong><br>
        controllerId: <span class="mono">${escapeHtml(cid)}</span><br>
        status: ${active ? "aktiv" : "utløpt/ikke satt"}<br>
        gjenstår: ${remaining === null ? "-" : (remaining + " sek")}<br>
        min controller: ${mine ? "ja" : "nei"}
      `;
    }

    function renderLease(state) {
      leaseBox.innerHTML = formatLease(state);
    }

    function parseChoices(text) {
      const lines = String(text || "")
        .split("\n")
        .map(x => x.trim())
        .filter(Boolean);

      const choices = [];
      const seen = new Set();

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        const parts = line.split("|").map(x => x.trim()).filter(Boolean);

        let id = "";
        let label = "";

        if (parts.length >= 2) {
          id = parts[0];
          label = parts.slice(1).join(" | ");
        } else {
          label = line;
          id = line;
        }

        if (!id || !label) throw new Error("Ugyldig choice på linje " + (i + 1) + ".");
        if (seen.has(id)) throw new Error("Duplisert choice-id: " + id);
        seen.add(id);

        choices.push({ id, label });
      }

      if (choices.length < 2) throw new Error("Multi krever minst 2 choices.");
      return choices;
    }

    function buildUrl(path, params) {
      const u = new URL(path, window.location.href);
      Object.entries(params || {}).forEach(([k, v]) => {
        if (v == null || v === "") return;
        u.searchParams.set(k, String(v));
      });
      return u.toString();
    }

    function openInNewTab(url) {
      // noopener for sikkerhet – og for å slippe at popup får kontroll på window.opener
      window.open(url, "_blank", "noopener");
    }

    async function copyToClipboard(text) {
      const t = String(text || "");
      if (!t) throw new Error("Mangler joinCode å kopiere.");

      if (navigator.clipboard && typeof navigator.clipboard.writeText === "function") {
        await navigator.clipboard.writeText(t);
        return;
      }

      // fallback
      const ta = document.createElement("textarea");
      ta.value = t;
      ta.style.position = "fixed";
      ta.style.left = "-9999px";
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      document.body.removeChild(ta);
    }

    function downloadJson(filename, obj) {
      const json = JSON.stringify(obj, null, 2);
      const blob = new Blob([json], { type: "application/json" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);

      URL.revokeObjectURL(url);
    }

    function renderSessionBox() {
      if (!activeSessionId) {
        sessionBox.innerHTML = "";
        return;
      }

      const displayUrl = (activeJoinCode)
        ? buildUrl("display.html", { joinCode: activeJoinCode })
        : null;

      const collectUrl = (activeJoinCode)
        ? buildUrl("innhenting.html", { joinCode: activeJoinCode })
        : null;

      const canOpen = !!activeJoinCode;

      sessionBox.innerHTML = `
        <strong>Aktiv session</strong><br>
        sessionId: <span class="mono">${escapeHtml(activeSessionId || "-")}</span><br>
        joinCode: <span class="mono">${escapeHtml(activeJoinCode || "-")}</span><br><br>

        <div class="btnRow">
          <button class="btn" id="openDisplayBtn" ${canOpen ? "" : "disabled"}>Åpne Display (joinCode)</button>
          <button class="btn" id="openCollectBtn" ${canOpen ? "" : "disabled"}>Åpne Innhenting (joinCode)</button>
          <button class="btn" id="copyJoinCodeBtn" ${canOpen ? "" : "disabled"}>Kopier joincode</button>
        </div>

        <div class="mt20">
          Display-link: <span class="mono">${escapeHtml(displayUrl || "-")}</span><br>
          Innhenting-link: <span class="mono">${escapeHtml(collectUrl || "-")}</span>
        </div>
      `;

      const openDisplayBtn = document.getElementById("openDisplayBtn");
      const openCollectBtn = document.getElementById("openCollectBtn");
      const copyJoinCodeBtn = document.getElementById("copyJoinCodeBtn");

      if (openDisplayBtn) {
        openDisplayBtn.addEventListener("click", () => {
          if (!activeJoinCode) return;
          openInNewTab(buildUrl("display.html", { joinCode: activeJoinCode }));
          setStatus("Åpnet display i nytt vindu.", "ok");
        });
      }

      if (openCollectBtn) {
        openCollectBtn.addEventListener("click", () => {
          if (!activeJoinCode) return;
          openInNewTab(buildUrl("innhenting.html", { joinCode: activeJoinCode }));
          setStatus("Åpnet innhenting i nytt vindu.", "ok");
        });
      }

      if (copyJoinCodeBtn) {
        copyJoinCodeBtn.addEventListener("click", async () => {
          try {
            await copyToClipboard(activeJoinCode);
            setStatus("Joincode kopiert: " + activeJoinCode, "ok");
          } catch (e) {
            const msg = e && e.message ? e.message : String(e);
            setError(msg);
            setStatus("Kunne ikke kopiere joincode.", "err");
            console.error(e);
          }
        });
      }
    }

    // -------- Steg 7: Programs UI --------

    function renderProgramDraftList() {
      if (!programDraftItems.length) return `<em>Ingen items i draft ennå.</em>`;
      const rows = programDraftItems.map((it, idx) => {
        const t = it && it.question && it.question.text ? it.question.text : "";
        return `
          <div class="mt10">
            <span class="mono">#${idx + 1}</span>
            <strong>${escapeHtml(it.mode)}</strong>
            ${t ? `– ${escapeHtml(t)}` : ""}
            <button class="btn" data-act="draftLoad" data-idx="${idx}">Last til editor</button>
            <button class="btn" data-act="draftRemove" data-idx="${idx}">Fjern</button>
          </div>
        `;
      }).join("");
      return rows;
    }

    function renderLoadedProgramList() {
      if (!loadedProgram) return `<em>Ingen program lastet.</em>`;
      const rows = loadedProgram.items.map((it, idx) => {
        const t = it && it.question && it.question.text ? it.question.text : "";
        const isSel = idx === loadedProgramIndex;
        return `
          <div class="mt10">
            <span class="mono">#${idx + 1}</span>
            <strong>${escapeHtml(it.mode)}</strong>
            ${t ? `– ${escapeHtml(t)}` : ""}
            <button class="btn" data-act="progSelect" data-idx="${idx}" ${isSel ? "disabled" : ""}>Velg</button>
            <button class="btn" data-act="progLoadEditor" data-idx="${idx}">Last til editor</button>
          </div>
        `;
      }).join("");
      return rows;
    }

    function renderProgramsBox() {
      if (!currentUser) {
        programsBox.innerHTML = "";
        return;
      }

      const activePid = "(hentes fra session ved attach)";
      const loadedTitle = loadedProgram ? loadedProgram.title : "";
      const loadedId = loadedProgram ? loadedProgram.programId : "";

      const progOptions = programsCache.length
        ? programsCache.map(p => `<option value="${escapeHtml(p.programId)}">${escapeHtml(p.title)} (${p.count})</option>`).join("")
        : `<option value="">(ingen programmer)</option>`;

      programsBox.innerHTML = `
        <strong>Programs + eksport (Steg 7)</strong><br>
        <div class="mt10">
          <label>Programtittel:</label><br>
          <input id="progTitle" class="inputWide" placeholder="F.eks. Septemberkonferansen – Del 1" />
        </div>

        <div class="mt10 btnRow">
          <button class="btn" id="addDraftItemBtn" ${activeSessionId ? "" : "disabled"}>Legg til spørsmål (fra editor) i draft</button>
          <button class="btn" id="clearDraftBtn">Tøm draft</button>
        </div>

        <div class="mt10">
          <strong>Draft (spørsmålssett)</strong><br>
          ${renderProgramDraftList()}
        </div>

        <div class="mt20 btnRow">
          <button class="btn" id="saveNewProgramBtn">Lagre nytt program</button>
          <button class="btn" id="refreshProgramsBtn">Oppdater programliste</button>
        </div>

        <hr class="mt20">

        <div class="mt10">
          <strong>Mine programmer</strong><br>
          <select id="programSel" class="inputWide">
            <option value="">(velg program)</option>
            ${progOptions}
          </select>
        </div>

        <div class="mt10 btnRow">
          <button class="btn" id="loadProgramBtn">Last program</button>
          <button class="btn" id="attachProgramBtn" ${activeSessionId ? "" : "disabled"}>Bruk program i aktiv session</button>
        </div>

        <div class="mt10">
          Lastet program: <span class="mono">${escapeHtml(loadedId || "-")}</span><br>
          Tittel: ${escapeHtml(loadedTitle || "-")}
        </div>

        <div class="mt10">
          <strong>Spørsmål i lastet program</strong><br>
          ${renderLoadedProgramList()}
        </div>

        <div class="mt20 btnRow">
          <button class="btn" id="setFromProgramBtn" ${activeSessionId && loadedProgram ? "" : "disabled"}>Set question (fra valgt item)</button>
          <button class="btn" id="startFromProgramBtn" ${activeSessionId && loadedProgram ? "" : "disabled"}>Start (fra valgt item)</button>
        </div>

        <hr class="mt20">

        <div class="mt10">
          <strong>Eksport (agg-JSON)</strong><br>
          Eksport tar kun aggregert data fra <span class="mono">rounds/*/agg/live</span> (aldri votes).
        </div>
        <div class="mt10 btnRow">
          <button class="btn" id="exportBtn" ${activeSessionId ? "" : "disabled"}>Eksporter session (JSON)</button>
        </div>
      `;

      // Wire handlers
      const addDraftItemBtn = document.getElementById("addDraftItemBtn");
      const clearDraftBtn = document.getElementById("clearDraftBtn");
      const saveNewProgramBtn = document.getElementById("saveNewProgramBtn");
      const refreshProgramsBtn = document.getElementById("refreshProgramsBtn");
      const loadProgramBtn = document.getElementById("loadProgramBtn");
      const attachProgramBtn = document.getElementById("attachProgramBtn");
      const setFromProgramBtn = document.getElementById("setFromProgramBtn");
      const startFromProgramBtn = document.getElementById("startFromProgramBtn");
      const exportBtn = document.getElementById("exportBtn");

      if (addDraftItemBtn) {
        addDraftItemBtn.addEventListener("click", () => {
          try {
            const m = document.getElementById("modeSel") ? document.getElementById("modeSel").value : null;
            if (!m) throw new Error("Mode ikke tilgjengelig (start session / vent på UI).");

            const text = (document.getElementById("qText").value || "").trim();
            let question = {};
            if (text) question.text = text;

            if (m === "multi") {
              const rawChoices = document.getElementById("multiChoices").value;
              question.choices = parseChoices(rawChoices);
            }

            // Stram form (matcher app.js normalize)
            const item = { mode: m, question: question };
            programDraftItems.push(item);
            renderProgramsBox();
            setStatus("La til item i draft (#" + programDraftItems.length + ").", "ok");
          } catch (e) {
            setError(e && e.message ? e.message : String(e));
            setStatus("Kunne ikke legge til i draft.", "err");
            console.error(e);
          }
        });
      }

      if (clearDraftBtn) {
        clearDraftBtn.addEventListener("click", () => {
          programDraftItems = [];
          renderProgramsBox();
          setStatus("Draft tømt.", "ok");
        });
      }

      if (saveNewProgramBtn) {
        saveNewProgramBtn.addEventListener("click", async () => {
          try {
            setError("");
            const title = (document.getElementById("progTitle").value || "").trim();
            if (!programDraftItems.length) throw new Error("Draft er tom. Legg til minst 1 spørsmål.");

            const res = await App.createProgram(title, programDraftItems);
            setStatus("Program lagret: " + res.programId, "ok");
            programDraftItems = [];
            await refreshPrograms();
            renderProgramsBox();
          } catch (e) {
            setError(e && e.message ? e.message : String(e));
            setStatus("Lagring av program feilet.", "err");
            console.error(e);
          }
        });
      }

      if (refreshProgramsBtn) {
        refreshProgramsBtn.addEventListener("click", async () => {
          try {
            await refreshPrograms();
            renderProgramsBox();
            setStatus("Programliste oppdatert.", "ok");
          } catch (e) {
            setError(e && e.message ? e.message : String(e));
            setStatus("Kunne ikke oppdatere programliste.", "err");
            console.error(e);
          }
        });
      }

      if (loadProgramBtn) {
        loadProgramBtn.addEventListener("click", async () => {
          try {
            setError("");
            const sel = document.getElementById("programSel").value;
            if (!sel) throw new Error("Velg et program først.");

            loadedProgram = await App.getProgram(sel);
            loadedProgramIndex = 0;
            renderProgramsBox();
            setStatus("Program lastet.", "ok");
          } catch (e) {
            setError(e && e.message ? e.message : String(e));
            setStatus("Kunne ikke laste program.", "err");
            console.error(e);
          }
        });
      }

      if (attachProgramBtn) {
        attachProgramBtn.addEventListener("click", async () => {
          try {
            setError("");
            if (!activeSessionId) throw new Error("Ingen aktiv session.");
            if (!loadedProgram) throw new Error("Last et program først.");

            await App.setSessionProgramId(activeSessionId, loadedProgram.programId);
            setStatus("Program koblet til aktiv session (programId oppdatert).", "ok");
          } catch (e) {
            setError(e && e.message ? e.message : String(e));
            setStatus("Kunne ikke koble program til session.", "err");
            console.error(e);
          }
        });
      }

      if (setFromProgramBtn) {
        setFromProgramBtn.addEventListener("click", async () => {
          try {
            setError("");
            if (!activeSessionId) throw new Error("Ingen aktiv session.");
            if (!loadedProgram) throw new Error("Ingen program lastet.");

            const it = loadedProgram.items[loadedProgramIndex];
            await App.setQuestionLease(activeSessionId, it.mode, it.question);
            setStatus("Spørsmål satt fra program (#" + (loadedProgramIndex + 1) + ").", "ok");
          } catch (e) {
            setError(e && e.message ? e.message : String(e));
            setStatus("Set question fra program feilet.", "err");
            console.error(e);
          }
        });
      }

      if (startFromProgramBtn) {
        startFromProgramBtn.addEventListener("click", async () => {
          try {
            setError("");
            if (!activeSessionId) throw new Error("Ingen aktiv session.");
            if (!loadedProgram) throw new Error("Ingen program lastet.");

            const it = loadedProgram.items[loadedProgramIndex];
            const res = await App.startQuestionLease(activeSessionId, it.mode, it.question);
            setStatus("Startet ny runde fra program: " + res.roundId, "ok");
          } catch (e) {
            setError(e && e.message ? e.message : String(e));
            setStatus("Start fra program feilet.", "err");
            console.error(e);
          }
        });
      }

      if (exportBtn) {
        exportBtn.addEventListener("click", async () => {
          try {
            setError("");
            if (!activeSessionId) throw new Error("Ingen aktiv session.");

            const data = await App.exportAggregatedJson(activeSessionId);

            const sid = data && data.session && data.session.sessionId ? data.session.sessionId : activeSessionId;
            const filename = "uv2_export_" + String(sid).slice(0, 8) + "_" + new Date().toISOString().slice(0, 19).replaceAll(":", "-") + ".json";
            downloadJson(filename, data);
            setStatus("Eksport lastet ned (agg).", "ok");
          } catch (e) {
            setError(e && e.message ? e.message : String(e));
            setStatus("Eksport feilet.", "err");
            console.error(e);
          }
        });
      }

      // Delegert klikk for draft/program-lister
      programsBox.querySelectorAll("button[data-act]").forEach(btn => {
        btn.addEventListener("click", () => {
          const act = btn.getAttribute("data-act");
          const idx = Number(btn.getAttribute("data-idx"));
          try {
            if (!Number.isFinite(idx)) return;

            if (act === "draftRemove") {
              programDraftItems.splice(idx, 1);
              renderProgramsBox();
              return;
            }

            if (act === "draftLoad") {
              const it = programDraftItems[idx];
              loadItemIntoEditor(it);
              setStatus("Draft item lastet til editor.", "ok");
              return;
            }

            if (act === "progSelect") {
              loadedProgramIndex = idx;
              renderProgramsBox();
              return;
            }

            if (act === "progLoadEditor") {
              const it = loadedProgram.items[idx];
              loadedProgramIndex = idx;
              loadItemIntoEditor(it);
              renderProgramsBox();
              setStatus("Program item lastet til editor.", "ok");
              return;
            }
          } catch (e) {
            setError(e && e.message ? e.message : String(e));
            setStatus("Handling feilet.", "err");
            console.error(e);
          }
        });
      });
    }

    function loadItemIntoEditor(item) {
      if (!item) throw new Error("Mangler item.");
      const modeSel = document.getElementById("modeSel");
      const qTextEl = document.getElementById("qText");
      if (!modeSel || !qTextEl) throw new Error("Editor ikke klar (vent på Controller UI).");

      modeSel.value = item.mode;
      const q = item.question || {};
      qTextEl.value = q.text ? String(q.text) : "";

      const multiBox = document.getElementById("multiBox");
      if (multiBox) multiBox.style.display = (item.mode === "multi") ? "" : "none";

      const choicesEl = document.getElementById("multiChoices");
      if (choicesEl) {
        if (item.mode === "multi" && Array.isArray(q.choices)) {
          choicesEl.value = q.choices.map(c => `${c.id} | ${c.label}`).join("\n");
        } else {
          choicesEl.value = "yes | ja\nno | nei";
        }
      }
    }

    async function refreshPrograms() {
      if (!currentUser) { programsCache = []; return; }
      programsCache = await App.listProgramsForOwner();
    }

    // -------- Steg 6 Controller UI (uendret funksjonelt) --------

    function renderControls() {
      if (!activeSessionId) {
        controlsBox.innerHTML = `<strong>Controller UI</strong><br>Start/velg en aktiv session først.`;
        return;
      }

      const status = lastState && lastState.status ? lastState.status : "(ukjent)";
      const roundId = lastState && lastState.roundId ? lastState.roundId : "-";
      const mode = lastState && lastState.mode ? lastState.mode : "";

      const q = lastState && lastState.question ? lastState.question : null;
      const qText = q && q.text ? String(q.text) : "";

      const multiChoices = (mode === "multi" && q && Array.isArray(q.choices))
        ? q.choices.map(c => `${c.id} | ${c.label}`).join("\n")
        : "yes | ja\nno | nei";

      controlsBox.innerHTML = `
        <strong>Controller UI (Steg 6)</strong><br>
        status: <span class="mono">${escapeHtml(status)}</span> |
        mode: <span class="mono">${escapeHtml(mode || "-")}</span> |
        roundId: <span class="mono">${escapeHtml(roundId)}</span><br><br>

        <strong>Spørsmål</strong><br>
        <label>
          Mode:
          <select id="modeSel" class="inputWide">
            <option value="multi" ${mode === "multi" ? "selected" : ""}>multi</option>
            <option value="likert" ${mode === "likert" ? "selected" : ""}>likert</option>
            <option value="open" ${mode === "open" ? "selected" : ""}>open</option>
            <option value="wordcloud" ${mode === "wordcloud" ? "selected" : ""}>wordcloud</option>
          </select>
        </label>

        <div class="mt20">
          <label>Spørsmålstekst (valgfri, men anbefalt):</label><br>
          <textarea id="qText" class="inputArea" rows="2" placeholder="Skriv spørsmålet her...">${escapeHtml(qText)}</textarea>
        </div>

        <div class="mt20" id="multiBox" style="${mode === "multi" ? "" : "display:none;"}">
          <label>Multi choices (én per linje): <span class="mono">id | label</span></label><br>
          <textarea id="multiChoices" class="inputArea" rows="5">${escapeHtml(multiChoices)}</textarea>
        </div>

        <div class="mt20 btnRow">
          <button class="btn" id="setQuestionBtn">Set question (mode + question)</button>
          <button class="btn" id="startQuestionBtn">Start (set + reset + collect)</button>
        </div>

        <div class="mt20 btnRow">
          <button class="btn" id="collectBtn">Collect</button>
          <button class="btn" id="resultsBtn">Results</button>
          <button class="btn" id="resetBtn">Reset (ny roundId)</button>
          <button class="btn" id="endSessionBtn">End session</button>
        </div>

        <div class="mt20">
          Tips: Normal flyt er <span class="mono">Set question</span> → <span class="mono">Start</span> → (Collect/Results) → <span class="mono">Reset</span> for neste runde.
        </div>
      `;

      const modeSel = document.getElementById("modeSel");

      // vis/skjul multibox ved mode-change (kun UI, ingen writes)
      modeSel.addEventListener("change", () => {
        const m = modeSel.value;
        const multiBox = document.getElementById("multiBox");
        if (multiBox) multiBox.style.display = (m === "multi") ? "" : "none";
      });

      document.getElementById("setQuestionBtn").addEventListener("click", async () => {
        try {
          setError("");
          setStatus("", "info");

          const m = modeSel.value;
          const text = (document.getElementById("qText").value || "").trim();

          let question = {};
          if (text) question.text = text;

          if (m === "multi") {
            const rawChoices = document.getElementById("multiChoices").value;
            question.choices = parseChoices(rawChoices);
          }

          await App.setQuestionLease(activeSessionId, m, question);
          setStatus("Spørsmål oppdatert (mode + question).", "ok");
        } catch (err) {
          const msg = (err && err.message) ? err.message : String(err);
          setError(msg);
          setStatus("Set question feilet.", "err");
          console.error(err);
        }
      });

      document.getElementById("startQuestionBtn").addEventListener("click", async () => {
        try {
          setError("");
          setStatus("", "info");

          const m = modeSel.value;
          const text = (document.getElementById("qText").value || "").trim();

          let question = {};
          if (text) question.text = text;

          if (m === "multi") {
            const rawChoices = document.getElementById("multiChoices").value;
            question.choices = parseChoices(rawChoices);
          }

          const res = await App.startQuestionLease(activeSessionId, m, question);
          setStatus("Startet ny runde: " + res.roundId, "ok");
        } catch (err) {
          const msg = (err && err.message) ? err.message : String(err);
          setError(msg);
          setStatus("Start feilet.", "err");
          console.error(err);
        }
      });

      document.getElementById("collectBtn").addEventListener("click", async () => {
        try {
          setError("");
          setStatus("", "info");
          await App.setLiveStatusLease(activeSessionId, "collect");
          setStatus("Status satt til collect.", "ok");
        } catch (err) {
          const msg = (err && err.message) ? err.message : String(err);
          setError(msg);
          setStatus("Collect feilet.", "err");
          console.error(err);
        }
      });

      document.getElementById("resultsBtn").addEventListener("click", async () => {
        try {
          setError("");
          setStatus("", "info");
          await App.setLiveStatusLease(activeSessionId, "results");
          setStatus("Status satt til results.", "ok");
        } catch (err) {
          const msg = (err && err.message) ? err.message : String(err);
          setError(msg);
          setStatus("Results feilet.", "err");
          console.error(err);
        }
      });

      document.getElementById("resetBtn").addEventListener("click", async () => {
        try {
          setError("");
          setStatus("", "info");
          const res = await App.resetRoundLease(activeSessionId);
          setStatus("Ny roundId: " + res.roundId, "ok");
        } catch (err) {
          const msg = (err && err.message) ? err.message : String(err);
          setError(msg);
          setStatus("Reset feilet.", "err");
          console.error(err);
        }
      });

      document.getElementById("endSessionBtn").addEventListener("click", async () => {
        try {
          setError("");
          setStatus("", "info");

          await App.endSession(activeSessionId);

          activeSessionId = null;
          activeJoinCode = null;
          lastState = null;
          if (unsubscribe) unsubscribe();
          unsubscribe = null;

          sessionBox.innerHTML = `<strong>Session avsluttet.</strong>`;
          controlsBox.innerHTML = "";
          renderLease(null);

          renderProgramsBox();
          setStatus("Session avsluttet.", "ok");
        } catch (err) {
          const msg = (err && err.message) ? err.message : String(err);
          setError(msg);
          setStatus("End session feilet.", "err");
          console.error(err);
        }
      });
    }

    function startLeaseTicker() {
      if (leaseTicker) clearInterval(leaseTicker);
      leaseTicker = setInterval(() => {
        renderLease(lastState);
      }, 1000);
    }

    function attachStateListener(sessionId) {
      if (unsubscribe) unsubscribe();

      unsubscribe = App.listenLiveState(
        sessionId,
        (data) => {
          lastState = data;
          renderLease(data);
          renderControls();
          renderProgramsBox(); // kun render, ingen writes
        },
        (err) => {
          setError("Kunne ikke lese state/live: " + (err && err.message ? err.message : String(err)));
          setStatus("Kunne ikke lese state/live.", "err");
        }
      );

      startLeaseTicker();
    }

    loginBtn.addEventListener("click", async () => {
      try {
        setError("");
        setStatus("", "info");
        const user = await App.ensureSignedInWithGoogle();
        renderUser(user);
        setStatus("Innlogging ok.", "ok");
      } catch (err) {
        setError(err && err.message ? err.message : String(err));
        setStatus("Innlogging feilet.", "err");
        console.error(err);
      }
    });

    startSessionBtn.addEventListener("click", async () => {
      try {
        setError("");
        setStatus("", "info");
        const res = await App.startOrReplaceSession({ saveResults: true, programId: null });

        activeSessionId = res.sessionId;
        activeJoinCode = res.joinCode;

        renderSessionBox();
        attachStateListener(res.sessionId);
        renderProgramsBox();

        setStatus("Ny session startet.", "ok");
      } catch (err) {
        const msg = (err && err.message) ? err.message : String(err);
        setError(msg);
        setStatus("Kunne ikke starte ny session.", "err");
        console.error(err);
      }
    });

    App.auth.onAuthStateChanged(async (user) => {
      currentUser = user || null;
      renderUser(user);

      if (!user) {
        activeSessionId = null;
        activeJoinCode = null;
        lastState = null;
        loadedProgram = null;
        loadedProgramIndex = 0;
        programDraftItems = [];
        programsCache = [];

        if (unsubscribe) unsubscribe();
        unsubscribe = null;
        if (leaseTicker) clearInterval(leaseTicker);
        leaseTicker = null;

        leaseBox.innerHTML = "";
        sessionBox.innerHTML = "";
        controlsBox.innerHTML = "";
        programsBox.innerHTML = "";
        statusBox.innerHTML = "";
        setError("");
        return;
      }

      try {
        setError("");
        const info = await App.getActiveSessionInfo(user.uid);
        if (info && info.activeSessionId) {
          activeSessionId = info.activeSessionId;
          activeJoinCode = info.activeJoinCode;

          renderSessionBox();
          attachStateListener(info.activeSessionId);
          setStatus("Aktiv session lastet (ingen writes).", "ok");
        } else {
          activeSessionId = null;
          activeJoinCode = null;
          renderSessionBox();
          leaseBox.innerHTML = `<strong>Controller lease</strong><br>Ingen aktiv session funnet på owner-peker.`;
          renderControls();
          setStatus("Ingen aktiv session funnet.", "warn");
        }

        await refreshPrograms();
        renderProgramsBox();

      } catch (e) {
        setError(e && e.message ? e.message : String(e));
        setStatus("Kunne ikke lese owner-peker / programmer.", "err");
        console.error(e);
      }
    });
  </script>
</body>
</html>
